name: Build and Push Docker Image

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_DB: postgres
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Build and Push Docker Image
        run: |
          docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
          docker build -t $DOCKER_USERNAME/techpost:latest --build-arg POSTGRES_URI=${{ secrets.DATABASE_URL }} --build-arg JWT_SECRET=${{ secrets.JWT_SECRET }} .
          docker push $DOCKER_USERNAME/techpost:latest

      - name: Install dependencies
        run: npm install --save-dev jest ts-jest typescript @types/jest

      - name: Run migrations
        run: npm run typeorm -- -d ./src/database/data-source.ts migration:run

      - name: Verify Jest installation
        run: npx jest --version

      - name: Run tests
        env:
          POSTGRES_DB: secrets.POSTGRES_DB
          POSTGRES_USER: secrets.POSTGRES_USER
          POSTGRES_PASSWORD: secrets.POSTGRES_PASSWORD
          POSTGRES_HOST: secrets.POSTGRES_HOST
          POSTGRES_PORT: secrets.POSTGRES_PORT
        run: npm test